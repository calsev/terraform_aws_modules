{{ name.map() }}

locals {
  create_policy_map = {
    for k, v in local.lx_map : k => merge(v, {
      repo_name = v.name_effective
    })
  }
  l0_map = {
    for k, v in var.repo_map : k => v
  }
  l1_map = {
    for k, v in local.l0_map : k => merge(v, module.name_map.data[k], {
      iam_policy_json       = v.iam_policy_json == null ? var.repo_iam_policy_json_default : v.iam_policy_json
      image_tag_mirror_list = v.image_tag_mirror_list == null ? var.repo_image_tag_mirror_list_default : v.image_tag_mirror_list
      lifecycle_rule_map    = v.lifecycle_rule_map == null ? var.repo_lifecycle_rule_map_default : v.lifecycle_rule_map
      lifecycle_tag_map     = v.lifecycle_tag_map == null ? var.repo_lifecycle_tag_map_default : v.lifecycle_tag_map
    })
  }
  l2_map = {
    for k, v in local.l0_map : k => {
      iam_policy_doc = local.l1_map[k].iam_policy_json == null ? null : jsondecode(local.l1_map[k].iam_policy_json)
      lifecycle_rule_map = merge(
        {
          for k_rule, v_rule in local.l1_map[k].lifecycle_rule_map : k_rule => merge(v_rule, {
            rulePriority = tonumber(k_rule)
          })
        },
        {
          for k_tag, v_tag in local.l1_map[k].lifecycle_tag_map : k_tag => {
            rulePriority = tonumber(k_tag)
            selection = {
              countNumber    = v_tag.tag_max_count
              countType      = "imageCountMoreThan"
              tagPatternList = v_tag.tag_pattern_list
              tagStatus      = "tagged"
            }
            action = {
              type = "expire"
            }
          }
        },
      )
      tags = merge(
        local.l1_map[k].tags,
        v.base_image == null ? {} : {
          # Below is the interface for ecr-mirror
          upstream-image = v.base_image
          upstream-tags  = join("/", local.l1_map[k].image_tag_mirror_list)
        },
      )
    }
  }
  l3_map = {
    for k, v in local.l0_map : k => {
      iam_policy_doc = local.l1_map[k].iam_policy_json == null ? null : jsondecode(local.l1_map[k].iam_policy_json)
      lifecycle_rule_list = [
        for k_rule, v_rule in local.l2_map[k].lifecycle_rule_map : v_rule
      ]
      tags = merge(
        local.l1_map[k].tags,
        v.base_image == null ? {} : {
          # Below is the interface for ecr-mirror
          upstream-image = v.base_image
          upstream-tags  = join("/", local.l1_map[k].image_tag_mirror_list)
        },
      )
    }
  }
  lx_map = {
    for k, _ in local.l0_map : k => merge(local.l1_map[k], local.l2_map[k], local.l3_map[k])
  }
  output_data = {
    for k, v in local.lx_map : k => merge(
      {
        for k_attr, v_attr in v : k_attr => v_attr if !contains(["iam_policy_json"], k_attr)
      },
      module.repo_policy.data[k],
      {
        repo_arn = aws_ecr_repository.this_repo[k].arn
        repo_url = aws_ecr_repository.this_repo[k].repository_url
      }
    )
  }
}
