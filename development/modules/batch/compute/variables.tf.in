variable "compute_map" {
  type = map(object({
    image_id                       = optional(string)
    instance_allocation_strategy   = optional(string)
    instance_allocation_type       = optional(string)
    instance_storage_gib           = optional(number)
    instance_type                  = optional(string)
    key_pair_key                   = optional(string)
    max_instances                  = optional(number)
    min_instances                  = optional(number)
    placement_group_id             = optional(string)
    update_job_termination_enabled = optional(bool)
    update_job_timeout_minutes     = optional(number)
    user_data_command_list         = optional(list(string))
    {{ vpc.var_item() }}
  }))
}

variable "compute_image_id_default" {
  type    = string
  default = null
}

variable "compute_instance_allocation_strategy_default" {
  type    = string
  default = "BEST_FIT"
  validation {
    condition     = contains(["BEST_FIT", "BEST_FIT_PROGRESSIVE", "SPOT_CAPACITY_OPTIMIZED", "SPOT_PRICE_CAPACITY_OPTIMIZED"], var.compute_instance_allocation_strategy_default)
    error_message = "Invalid allocation type"
  }
}

variable "compute_instance_allocation_type_default" {
  type    = string
  default = "EC2"
  validation {
    condition     = contains(["EC2", "FARGATE", "FARGATE_SPOT", "SPOT"], var.compute_instance_allocation_type_default)
    error_message = "Invalid allocation type"
  }
}

variable "compute_instance_storage_gib_default" {
  type    = number
  default = 30
}

variable "compute_instance_type_default" {
  type    = string
  default = null
}

variable "compute_key_pair_key_default" {
  type    = string
  default = null
}

variable "compute_max_instances_default" {
  type        = number
  default     = 1
  description = "For Fargate this is the number of vCPUs"
}

variable "compute_min_instances_default" {
  type        = number
  default     = 0
  description = "Ignored for Fargate"
}

variable "compute_placement_group_id_default" {
  type    = string
  default = null
}

variable "compute_update_job_termination_enabled_default" {
  type    = bool
  default = false
}

variable "compute_update_job_timeout_minutes_default" {
  type    = number
  default = null
}

variable "compute_user_data_command_list_default" {
  type    = list(string)
  default = null
}

variable "iam_data" {
  type = object({
    iam_instance_profile_arn_ecs  = string
    iam_role_arn_batch_service    = string
    iam_role_arn_batch_spot_fleet = string
    key_pair_map = map(object({
      key_pair_name = string
    }))
  })
}

variable "monitor_data" {
  type = object({
    ecs_ssm_param_map = object({
      cpu = object({
        name_effective = string
      })
      gpu = object({
        name_effective = string
      })
    })
  })
}

{{ name.var() }}

{{ std.map() }}

{{ vpc.var() }}
