variable "alert_level_default" {
  type    = string
  default = "general_medium"
}

variable "monitor_data" {
  type = object({
    alert = object({
      topic_map = map(object({
        topic_arn = string
      }))
    })
  })
}

variable "engine_to_security_group_key_list" {
  type = map(list(string))
  default = {
    mysql = [
      "internal_mysql_in",
      "world_all_out",
    ]
    postgres = [
      "internal_postgres_in",
      "world_all_out",
    ]
  }
  description = "A list of engine to security group key"
}

variable "db_map" {
  type = map(object({
    active_directory_domain               = optional(string)
    alarm_map = optional(map(object({
      alarm_action_enabled                = optional(bool)
      alarm_description                   = string # Human-friendly description
      alarm_name                          = string # Human-friendly name
      alert_level                         = optional(string)
      metric_name                         = optional(string)
      metric_namespace                    = optional(string)
      statistic_comparison_operator       = optional(string)
      statistic_evaluation_period_count   = optional(number)
      statistic_evaluation_period_seconds = optional(number)
      statistic_for_metric                = optional(string)
      statistic_threshold_percentile      = optional(number)
      statistic_threshold_value           = optional(number)
    })))
    allocated_storage_gib                 = optional(number)
    allocated_storage_max_gib             = optional(number) # Set nonzero to enable storage autoscaling
    allow_major_version_upgrade           = optional(bool)
    apply_immediately                     = optional(bool)
    auto_minor_version_upgrade            = optional(bool)
    availability_zone_key                 = optional(string)
    backup_retention_period_day           = optional(number)
    backup_window_utc                     = optional(string)
    blue_green_update_enabled             = optional(bool)
    ca_cert_identifier                    = optional(string)
    character_set_name                    = optional(string)       # For Oracle and Microsoft SQL
    cloudwatch_log_export_list            = optional(list(string)) # See per-engine value here: https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/db_instance#enabled_db_enabled_cloudwatch_log_export_defaults
    create_instance                       = optional(bool)
    copy_tags_to_snapshot                 = optional(bool)
    db_initial_name                       = optional(string)
    delete_automated_backups              = optional(bool)
    deletion_protection                   = optional(bool)
    engine                                = optional(string) # Do not spec for replica
    engine_version                        = optional(string) # Do not spec for replica; changes ignored
    final_snapshot_enabled                = optional(bool)
    final_snapshot_identifier             = optional(string) # Defaults to name_effective
    iam_database_authentication_enabled   = optional(bool)
    iam_instance_profile_arn_custom       = optional(bool)
    iam_role_name_active_directory_domain = optional(string)
    #    ignore_change_list                        = optional(list(string))
    instance_class                            = optional(string)
    instance_identifier_is_prefix             = optional(bool)
    kms_key_id                                = optional(string)
    license_model                             = optional(string) # Only for Oracle
    maintenance_window_utc                    = optional(string)
    monitoring_interval_s                     = optional(number)
    multi_az                                  = optional(bool)
    {{ name.var_item() }}
    nchar_character_set_name                  = optional(string) # Oracle and MSSQL only
    network_type                              = optional(string)
    option_group_name                         = optional(string)
    password_secret_name_append               = optional(string)
    parameter_group_name                      = optional(string)
    performance_insights_kms_key_arn          = optional(string)
    performance_insights_retention_period_day = optional(number)
    port                                      = optional(number)
    provisioned_iops                          = optional(number) # Will override storage type
    publicly_accessible                       = optional(bool)
    replica_mode_for_oracle                   = optional(string)
    replicate_source_db_id                    = optional(string)
    snapshot_arn                              = optional(string)
    storage_encrypted                         = optional(bool)
    storage_throughput                        = optional(number)
    storage_type                              = optional(string)
    subnet_group_key                          = optional(string) # For read replica, only if writer in different region
    timezone_for_ms_sql                       = optional(string)
    secret_is_param                           = optional(bool)
    username                                  = optional(string)
  }))
}

variable "db_active_directory_domain_default" {
  type    = string
  default = null
}

variable "db_alarm_map_default" {
  type = map(object({
    alarm_action_enabled                = optional(bool)
    alarm_description                   = string # Human-friendly description
    alarm_name                          = string # Human-friendly name
    alert_level                         = optional(string)
    metric_name                         = optional(string)
    metric_namespace                    = optional(string)
    statistic_comparison_operator       = optional(string)
    statistic_evaluation_period_count   = optional(number)
    statistic_evaluation_period_seconds = optional(number)
    statistic_for_metric                = optional(string)
    statistic_threshold_percentile      = optional(number)
    statistic_threshold_value           = optional(number)
  }))
  default = {
    cpu_utilization = {
      alarm_action_enabled                = null
      alarm_description                   = "Alarm when CPU utilization is high for database %s"
      alarm_name                          = "CPU Usage for %s"
      alert_level                         = null
      metric_name                         = "CPUUtilization"
      metric_namespace                    = "AWS/RDS"
      statistic_comparison_operator       = "GreaterThanThreshold"
      statistic_evaluation_period_count   = 2
      statistic_evaluation_period_seconds = 300
      statistic_for_metric                = "Average"
      statistic_threshold_percentile      = null
      statistic_threshold_value           = 80
    }
    disk_queue = {
      alarm_action_enabled                = null
      alarm_description                   = "Alarm when disk queue depth is high for database %s"
      alarm_name                          = "Disk Queue for %s"
      alert_level                         = null
      metric_name                         = "DiskQueueDepth"
      metric_namespace                    = "AWS/RDS"
      statistic_comparison_operator       = "GreaterThanThreshold"
      statistic_evaluation_period_count   = 2
      statistic_evaluation_period_seconds = 300
      statistic_for_metric                = "Average"
      statistic_threshold_percentile      = null
      statistic_threshold_value           = 10
    }
    freeable_memory = {
      alarm_action_enabled                = null
      alarm_description                   = "Alarm when freeable memory is low for database %s"
      alarm_name                          = "Free Memory for %s"
      alert_level                         = null
      metric_name                         = "FreeableMemory"
      metric_namespace                    = "AWS/RDS"
      statistic_comparison_operator       = "LessThanThreshold"
      statistic_evaluation_period_count   = 3
      statistic_evaluation_period_seconds = 300
      statistic_for_metric                = "Average"
      statistic_threshold_percentile      = null
      statistic_threshold_value           = 1024 * 1024 * 1024 # 1 GiB
    }
    read_iops = {
      alarm_action_enabled                = null
      alarm_description                   = "Alarm when read IOPS is high for database %s"
      alarm_name                          = "Read IOPS for %s"
      alert_level                         = null
      metric_name                         = "ReadIOPS"
      metric_namespace                    = "AWS/RDS"
      statistic_comparison_operator       = "GreaterThanThreshold"
      statistic_evaluation_period_count   = 3
      statistic_evaluation_period_seconds = 300
      statistic_for_metric                = "Average"
      statistic_threshold_percentile      = null
      statistic_threshold_value           = 500
    }
    storage_space = {
      alarm_action_enabled                = null
      alarm_description                   = "Alarm when storage is low for database %s"
      alarm_name                          = "Storage for %s"
      alert_level                         = null
      metric_name                         = "FreeStorageSpace"
      metric_namespace                    = "AWS/RDS"
      statistic_comparison_operator       = "LessThanThreshold"
      statistic_evaluation_period_count   = 3
      statistic_evaluation_period_seconds = 300
      statistic_for_metric                = "Average"
      statistic_threshold_percentile      = null
      statistic_threshold_value           = 10 * 1024 * 1024 * 1024 # 10 GiB
    }
    write_iops = {
      alarm_action_enabled                = null
      alarm_description                   = "Alarm when write IOPS is high for database %s"
      alarm_name                          = "Write IOPS for %s"
      alert_level                         = null
      metric_name                         = "WriteIOPS"
      metric_namespace                    = "AWS/RDS"
      statistic_comparison_operator       = "GreaterThanThreshold"
      statistic_evaluation_period_count   = 3
      statistic_evaluation_period_seconds = 300
      statistic_for_metric                = "Average"
      statistic_threshold_percentile      = null
      statistic_threshold_value           = 500
    }
  }
}

variable "db_allocated_storage_gib_default" {
  type    = number
  default = 20
  validation {
    condition     = 20 <= var.db_allocated_storage_gib_default
    error_message = "Minimum storage is 20 GiB"
  }
}

variable "db_allocated_storage_max_gib_default" {
  type    = number
  default = 80
}

variable "db_allow_major_version_upgrade_default" {
  type    = bool
  default = false
}

variable "db_apply_immediately_default" {
  type    = bool
  default = false
}

variable "db_auto_minor_version_upgrade_default" {
  type    = bool
  default = true
}

variable "db_availability_zone_key_default" {
  type    = string
  default = "a"
}

variable "db_backup_retention_period_day_default" {
  type    = number
  default = 14
  validation {
    condition     = 0 <= var.db_backup_retention_period_day_default && var.db_backup_retention_period_day_default <= 35
    error_message = "Invalid retention period"
  }
  description = "Must be greater than zero for a replication source. A medium-severity security finding if set less than 7."
}

variable "db_backup_window_utc_default" {
  type        = string
  default     = "05:00-07:00"
  description = "Backup and maintenance windows cannot overlap. This must match backup window for a Backup plan or will conflict."
}

variable "db_blue_green_update_enabled_default" {
  type    = bool
  default = false
}

variable "db_ca_cert_identifier_default" {
  type    = string
  default = null
}

variable "db_character_set_name_default" {
  type    = string
  default = null
}

variable "db_cloudwatch_log_export_list_map_default" {
  type = map(list(string))
  default = {
    db2       = ["diag.log", "notify.log"]
    mariadb   = ["audit", "error", "general", "slowquery"]
    mysql     = ["audit", "error", "general", "slowquery"]
    oracle    = ["alert", "audit", "listener", "trace"] # oemagent
    postgres  = ["postgresql", "upgrade"]
    sqlserver = ["agent", "error"]
  }
  description = "A map of engine family to log exports. See https://docs.aws.amazon.com/securityhub/latest/userguide/rds-controls.html#rds-9"
}

variable "db_copy_tags_to_snapshot_default" {
  type    = bool
  default = true
}

variable "db_create_instance_default" {
  type        = bool
  default     = true
  description = "If false, all values will be calcualted and all resources but the instance will be created."
}

variable "db_delete_automated_backups_default" {
  type    = bool
  default = false
}

variable "db_deletion_protection_default" {
  type        = bool
  default     = true
  description = "A medium-severity security finding if disabled."
}

variable "db_engine_default" {
  type    = string
  default = null
}

variable "db_engine_version_default" {
  type    = string
  default = null
}

variable "db_iam_database_authentication_enabled_default" {
  type    = bool
  default = true
}

variable "db_iam_instance_profile_arn_custom_default" {
  type    = string
  default = null
}

variable "db_iam_role_name_active_directory_domain_default" {
  type    = string
  default = null
}

variable "db_initial_name_default" {
  type    = string
  default = null
}

variable "db_instance_class_default" {
  type    = string
  default = "db.t4g.micro"
}

variable "db_instance_identifier_is_prefix_default" {
  type    = bool
  default = false
}

variable "db_kms_key_id_default" {
  type    = string
  default = null
}

variable "db_license_model_default" {
  type    = string
  default = null
}

variable "db_maintenance_window_utc_default" {
  type        = string
  default     = "Sun:07:00-Sun:08:00"
  description = "Backup and maintenance windows cannot overlap"
}

variable "db_monitoring_interval_s_default" {
  type        = number
  default     = 60
  description = "The interval for collecting enhanced metrics. Set nonzero to enable enhanced metrics."
  validation {
    condition     = contains([0, 1, 5, 10, 15, 30, 60], var.db_monitoring_interval_s_default)
    error_message = "Invalid monitoring interval"
  }
}

variable "db_multi_az_default" {
  type    = bool
  default = false
}

variable "db_nchar_character_set_name_default" {
  type    = string
  default = null
}

variable "db_network_type_default" {
  type    = string
  default = "DUAL"
  validation {
    condition     = contains(["IPV4", "DUAL"], var.db_network_type_default)
    error_message = "Invalid networking type"
  }
}

variable "db_option_group_name_default" {
  type    = string
  default = null
}

variable "db_parameter_group_name_default" {
  type    = string
  default = null
}

variable "db_performance_insights_kms_key_arn_default" {
  type        = string
  default     = null
  description = "Must be null to disable performance insights"
}

variable "db_performance_insights_retention_period_day_default" {
  type        = number
  default     = 7
  description = "Must be null to disable performance insights. Up to 7 days is free."
  validation {
    condition     = contains([7, 31, 62, 93, 124, 155, 186, 217, 248, 279, 310, 341, 372, 403, 434, 465, 496, 527, 558, 589, 620, 651, 682, 713, 731], var.db_performance_insights_retention_period_day_default)
    error_message = "Invalid retention period"
  }
}

variable "db_port_default" {
  type        = number
  default     = null
  description = "Will default to engine-specific port"
}

variable "db_provisioned_iops_default" {
  type    = number
  default = null
}

variable "db_publicly_accessible_default" {
  type    = bool
  default = false
}

variable "db_replica_mode_for_oracle_default" {
  type    = string
  default = null
  validation {
    condition     = var.db_replica_mode_for_oracle_default == null ? true : contains(["mounted", "open-read-only"], var.db_replica_mode_for_oracle_default)
    error_message = "Invalid replica mode"
  }
}

variable "db_replicate_source_db_id_default" {
  type    = string
  default = null
}

variable "db_final_snapshot_enabled_default" {
  type        = bool
  default     = true
  description = "Do not spec for replica"
}

variable "db_snapshot_arn_default" {
  type    = string
  default = null
}

variable "db_storage_encrypted_default" {
  type    = bool
  default = true
}

variable "db_storage_throughput_default" {
  type    = number
  default = null
}

variable "db_storage_type_default" {
  type    = string
  default = "gp3"
}

variable "db_subnet_group_key_default" {
  type    = string
  default = null
}

variable "db_timezone_for_ms_sql_default" {
  type    = string
  default = null
}

variable "db_secret_is_param_default" {
  type        = bool
  default     = false
  description = "If true, an SSM param will be created, otherwise a SM secret"
}

variable "db_username_default" {
  type    = string
  default = null
}

variable "iam_data" {
  type = object({
    iam_role_arn_rds_monitor = string
  })
  default     = null
  description = "Must be provided if performance insights are enabled - they are by default"
}

{{ name.var(app_fields=False) }}

variable "password_secret_name_append_default" {
  type    = string
  default = "db"
}

variable "subnet_group_map" {
  type = map(object({
    name_effective  = string
    vpc_key         = string
    vpc_segment_key = string
  }))
}

{{ vpc.var(vpc=False, az=False, seg=False, sg=False) }}

{{ std.map() }}
