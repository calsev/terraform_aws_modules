resource "aws_flow_log" "this_log" {
  for_each                   = local.lx_map
  deliver_cross_account_role = each.value.iam_role_arn_cross_account_delivery
  destination_options {
    file_format                = each.value.destination_file_format
    hive_compatible_partitions = each.value.destination_hive_compatible_partitions_enabled
    per_hour_partition         = each.value.destination_per_hour_partition_enabled
  }
  eni_id               = each.value.eni_id
  iam_role_arn         = each.value.iam_role_arn_cloudwatch_logs
  log_destination      = each.value.destination_arn
  log_destination_type = each.value.destination_type
  # log_group_name # Obsolete, conflicts with log_destination
  log_format                    = each.value.log_format
  max_aggregation_interval      = each.value.max_aggregation_interval_seconds
  region                        = var.std_map.aws_region_name
  regional_nat_gateway_id       = each.value.regional_nat_gateway_id
  subnet_id                     = each.value.subnet_id
  tags                          = each.value.tags
  traffic_type                  = each.value.traffic_type
  transit_gateway_attachment_id = each.value.transit_gateway_attachment_id
  transit_gateway_id            = each.value.transit_gateway_id
  vpc_id                        = each.value.vpc_id
}

module "athena_db" {
  source                          = "../../athena/database"
  db_map                          = local.create_db_x_map
  std_map                         = var.std_map
}

module "athena_table_query" {
  source               = "../../athena/named_query"
  athena_database_map  = module.athena_db.data
  name_prepend_default = "vpc_table"
  query_map            = local.create_db_table_map
  std_map              = var.std_map
}

module "athena_destination_query" {
  source               = "../../athena/named_query"
  athena_database_map  = module.athena_db.data
  name_prepend_default = "vpc_destination"
  query_map            = local.create_db_destination_map
  std_map              = var.std_map
}

module "athena_source_query" {
  source               = "../../athena/named_query"
  athena_database_map  = module.athena_db.data
  name_prepend_default = "vpc_source"
  query_map            = local.create_db_source_map
  std_map              = var.std_map
}

module "athena_nat_query" {
  source               = "../../athena/named_query"
  athena_database_map  = module.athena_db.data
  name_prepend_default = "vpc_nat"
  query_map            = local.create_db_nat_map
  std_map              = var.std_map
}
