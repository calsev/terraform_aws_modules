{{ name.map() }}

locals {
  create_destination_1_list = flatten([
    for k, v in local.lx_map : [
      for k_dest, v_dest in v.destination_map : merge(v, v_dest, {
        configuration_set_name = aws_sesv2_configuration_set.this_config[k].configuration_set_name
        k      = k
        k_all  = "${k}_${k_dest}"
        k_dest = k_dest
      })
    ]
  ])
  create_destination_x_map = {
    for v in local.create_destination_1_list : v.k_all => merge(v, {
    })
  }
  l0_map = {
    for k, v in var.config_map : k => v
  }
  l1_map = {
    for k, v in local.l0_map : k => merge(v, module.name_map.data[k], {
      auto_suppress_address_reason_list              = v.auto_suppress_address_reason_list == null ? var.config_auto_suppress_address_reason_list_default : v.auto_suppress_address_reason_list
      destination_map                                = v.destination_map == null ? var.config_destination_map_default : v.destination_map
      ip_pool_key                                    = v.ip_pool_key == null ? var.config_ip_pool_key_default : v.ip_pool_key
      reputation_metrics_enabled                     = v.reputation_metrics_enabled == null ? var.config_reputation_metrics_enabled_default : v.reputation_metrics_enabled
      sending_enabled                                = v.sending_enabled == null ? var.config_sending_enabled_default : v.sending_enabled
      tls_required                                   = v.tls_required == null ? var.config_tls_required_default : v.tls_required
      tracking_custom_redirect_domain                = v.tracking_custom_redirect_domain == null ? var.config_tracking_custom_redirect_domain_default : v.tracking_custom_redirect_domain
      vdm_dashboard_engagement_metrics_enabled       = v.vdm_dashboard_engagement_metrics_enabled == null ? var.config_vdm_dashboard_engagement_metrics_enabled_default : v.vdm_dashboard_engagement_metrics_enabled
      vdm_guardian_optimized_shared_delivery_enabled = v.vdm_guardian_optimized_shared_delivery_enabled == null ? var.config_vdm_guardian_optimized_shared_delivery_enabled_default : v.vdm_guardian_optimized_shared_delivery_enabled
    })
  }
  l2_map = {
    for k, v in local.l0_map : k => {
      ip_pool_name = local.l1_map[k].ip_pool_key == null ? null : var.ip_pool_data_map[local.l1_map[k].ip_pool_key].name_effective
    }
  }
  lx_map = {
    for k, _ in local.l0_map : k => merge(local.l1_map[k], local.l2_map[k])
  }
  output_data = {
    for k, v in local.lx_map : k => merge(
      {
        for k_attr, v_attr in v : k_attr => v_attr if !contains([], k_attr)
      },
      {
        arn                    = aws_sesv2_configuration_set.this_config[k].arn
        configuration_set_name = aws_sesv2_configuration_set.this_config[k].configuration_set_name
        destination_map = {
          for k_dest, v_dest in v.destination_map : k_dest => merge(v_dest, {
            destination_id = aws_sesv2_configuration_set_event_destination.destination["${k}_${k_dest}"].id
          })
        }
      },
    )
  }
}
